generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL") // 根据您的设置
}

model User {
  id              String              @id @default(cuid())
  email           String              @unique
  username        String              @unique
  password        String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  Todo            Todo[]
  Recipe          Recipe[]
  healthMetrics   UserHealthMetric[]
  aiChatSessions  AiChatSession[]
  exchangeQueries UserExchangeQuery[]
  wordProgress    UserWordProgress[]

  @@map("users")
}

model VocabularyWord {
  id          String   @id @default(cuid())
  english     String   @unique
  chinese     String   @db.Text
  phonetic_us String?
  phonetic_uk String?
  tags        Json?    @db.Json
  source      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userProgress UserWordProgress[]

  @@index([english])
  @@index([source])
  @@map("vocabulary_words")
}

model UserWordProgress {
  id               String @id @default(cuid())
  userId           String
  vocabularyWordId String

  isMemorized    Boolean   @default(false)
  lastReviewedAt DateTime?
  nextReviewAt   DateTime?
  familiarity    Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  vocabularyWord VocabularyWord @relation(fields: [vocabularyWordId], references: [id], onDelete: Cascade)

  @@unique([userId, vocabularyWordId])
  @@index([userId, isMemorized])
  @@index([userId, nextReviewAt])
  @@map("user_word_progress")
}

model Todo {
  id        String    @id @default(cuid())
  title     String    @default("无标题待办")
  content   String?   @db.Text
  completed Boolean   @default(false)
  important Boolean   @default(false)
  startDate DateTime?
  endDate   DateTime?
  image     String?   @db.MediumText
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, startDate])
  @@index([userId, endDate])
  @@index([userId, title]) // 为标题添加索引，如果经常按标题搜索的话
}

// ... (其他模型保持不变) ...

model Recipe {
  id           String   @id @default(cuid())
  name         String
  ingredients  String   @db.Text
  instructions String   @db.Text
  category     String?
  prepTime     String?
  cookTime     String?
  isFavorite   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, isFavorite])
  @@map("recipes")
}

model UserHealthMetric {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recordedAt         DateTime @default(now())
  heightCm           Float?
  weightKg           Float?
  ageAtRecording     Int?
  gender             String?
  activityLevel      String?
  neckCm             Float?
  waistCm            Float?
  hipCm              Float?
  bmi                Float?
  bmr                Float?
  tdee               Float?
  bodyFatPercent     Float?
  recommendedWaterMl Float?
  notes              String?  @db.Text
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([userId, recordedAt])
  @@map("user_health_metrics")
}

model AiChatSession {
  id        String          @id @default(cuid())
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  messages  AiChatMessage[]

  @@index([userId, updatedAt])
  @@map("ai_chat_sessions")
}

model AiChatMessage {
  id        String        @id @default(cuid())
  role      String
  content   String        @db.Text
  createdAt DateTime      @default(now())
  sessionId String
  session   AiChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("ai_chat_messages")
}

model ExchangeRate {
  id             String   @id @default(cuid())
  baseCurrency   String
  targetCurrency String
  rate           Float
  name           String?
  updatedAt      DateTime
  source         String?

  @@unique([baseCurrency, targetCurrency])
  @@index([baseCurrency])
  @@index([updatedAt])
  @@map("exchange_rates")
}

model UserExchangeQuery {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fromCurrency String
  toCurrency   String
  amount       Float
  result       Float
  rate         Float
  queriedAt    DateTime @default(now())

  @@index([userId, queriedAt])
  @@map("user_exchange_queries")
}

model Ai2048Experience {
  id     String @id @default(cuid())
  gameId String @default(cuid())

  initialBoardStateJson String @db.Text
  finalBoardStateJson   String @db.Text
  moveSequenceJson      String @db.Text
  scoreAchieved         Int
  highestTile           Int
  numberOfMoves         Int

  createdAt DateTime @default(now())
  notes     String?

  @@index([scoreAchieved, highestTile, createdAt(sort: Desc)])
  @@index([gameId])
  @@map("ai_global_2048_experiences")
}
